(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function o(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(i){if(i.ep)return;i.ep=!0;const r=o(i);fetch(i.href,r)}})();const j={Pending:"pending",Active:"active",Done:"done",Skipped:"skipped"},E=6,D=8,Q=["A","B","C","D","E","F"];function q(e,t){return`${Q[e]}${t+1}`}const f={Disconnected:"disconnected",Connecting:"connecting",Connected:"connected",Error:"error"},C={Idle:"idle",Running:"running",Paused:"paused",Complete:"complete"},O={None:"none",CalibratingA1:"a1",CalibratingA8:"a8",CalibratingF1:"f1",Complete:"complete"},U={dwellTimeSec:120,feedRate:3e3,zFeedRate:300,penUpValue:0,penDownValue:7};function ee(){const e=new Map;for(let t=0;t<E;t++)for(let o=0;o<D;o++)e.set(q(t,o),j.Pending);return e}function ce(){return{connection:f.Disconnected,machinePosition:{x:0,y:0},penDown:!1,calibration:null,calibrationStep:O.None,runConfig:{...U},runState:C.Idle,currentWell:null,wellStates:ee(),dwellRemainingSec:0,consoleLog:[]}}class de{state=ce();listeners=new Set;subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}update(t){Object.assign(this.state,t),this.notify()}log(t){this.state.consoleLog.push(t),this.state.consoleLog.length>500&&(this.state.consoleLog=this.state.consoleLog.slice(-500)),this.notify()}resetWells(){this.state.wellStates=ee(),this.state.currentWell=null,this.state.dwellRemainingSec=0,this.notify()}notify(){for(const t of this.listeners)t()}}const n=new de,te="gsis-bot:calibration",ne="gsis-bot:config";function ue(e){localStorage.setItem(te,JSON.stringify(e))}function pe(){const e=localStorage.getItem(te);if(!e)return null;try{return JSON.parse(e)}catch{return null}}function fe(e){localStorage.setItem(ne,JSON.stringify(e))}function ge(){const e=localStorage.getItem(ne);if(!e)return{...U};try{return{...U,...JSON.parse(e)}}catch{return{...U}}}let y=null,$=null,T=null,Y=!1,oe=null;const me=new TextEncoder,K=115200;function be(e){oe=e}async function we(){if(y)throw new Error("Already connected");n.update({connection:f.Connecting});try{if(y=await navigator.serial.requestPort(),await y.open({baudRate:K}),!y.readable||!y.writable)throw new Error("Port is not readable/writable");$=y.readable.getReader(),T=y.writable.getWriter(),n.update({connection:f.Connected}),n.log(`[serial] Connected at ${K} baud`),Y=!0,he()}catch(e){throw y=null,$=null,T=null,n.update({connection:f.Error}),n.log(`[serial] Connection failed: ${e}`),e}}async function Ce(){Y=!1;try{$&&(await $.cancel(),$.releaseLock(),$=null),T&&(T.releaseLock(),T=null),y&&(await y.close(),y=null)}catch{}n.update({connection:f.Disconnected}),n.log("[serial] Disconnected")}async function ae(e){if(!T)throw new Error("Not connected");const t=me.encode(e+`
`);await T.write(t),n.log(`> ${e}`)}function se(){return y!==null&&n.state.connection===f.Connected}async function he(){let e="";const t=new TextDecoder;for(;Y&&$;)try{const{value:o,done:a}=await $.read();if(a)break;e+=t.decode(o,{stream:!0});const i=e.split(`
`);e=i.pop()??"";for(const r of i){const l=r.replace(/\r/g,"").trim();l.length>0&&(n.log(`< ${l}`),oe?.(l))}}catch(o){Y&&(n.log(`[serial] Read error: ${o}`),n.update({connection:f.Error}));break}}const k=[];let w=null,M=null;function ye(e){if(e.startsWith("<")&&e.endsWith(">")){const t=ve(e);t&&(M?.(t),n.update({machinePosition:{x:t.mpos.x,y:t.mpos.y}}));return}if(e.startsWith("Grbl")){n.log(`[grbl] Controller ready: ${e}`);return}if(w){e==="ok"?(w.resolve("ok"),w=null,X()):e.startsWith("error")&&(w.reject(new Error(e)),w=null,X());return}}function ve(e){const o=e.slice(1,-1).split("|"),a=o[0];let i={x:0,y:0,z:0};for(const r of o)if(r.startsWith("MPos:")){const l=r.slice(5).split(",").map(Number);i={x:l[0]??0,y:l[1]??0,z:l[2]??0}}return{state:a,mpos:i}}function X(){w||k.length===0||se()&&(w=k.shift(),ae(w.command).catch(e=>{w?.reject(e),w=null}))}function v(e){return new Promise((t,o)=>{k.push({command:e,resolve:t,reject:o}),X()})}function J(){se()&&ae("?").catch(()=>{})}function xe(e=200,t=3e4){return new Promise((o,a)=>{const i=M,r=()=>{clearInterval(l),clearTimeout(d),M=i},l=setInterval(()=>{J()},e),d=setTimeout(()=>{r(),a(new Error("waitForIdle timed out"))},t);M=m=>{i?.(m),m.state==="Idle"&&(r(),o())},J()})}function Ne(){be(ye)}function Se(){for(const e of k)e.reject(new Error("Queue cleared"));k.length=0,w&&(w.reject(new Error("Queue cleared")),w=null)}async function z(e,t){await v(`G1 X${e.x.toFixed(3)} Y${e.y.toFixed(3)} F${t}`)}async function G(e,t){await v("G91"),await v(`G0 X${e.toFixed(3)} Y${t.toFixed(3)}`),await v("G90")}async function V(){const{penUpValue:e,zFeedRate:t}=n.state.runConfig;await v(`G1 Z${e} F${t}`),n.update({penDown:!1})}async function ie(){const{penDownValue:e,zFeedRate:t}=n.state.runConfig;await v(`G1 Z${e} F${t}`),n.update({penDown:!0})}async function _e(){await v("$H")}async function Pe(){await v("$X")}async function Re(){await v("G10 L20 P1 X0 Y0")}async function $e(){await v("G90")}async function Le(){await v("G21")}async function Fe(){await new Promise(e=>setTimeout(e,1500)),await $e(),await Le()}async function Ie(e){const{feedRate:t}=n.state.runConfig;await z(e,t)}function s(e,t,...o){const a=document.createElement(e);if(t)for(const[i,r]of Object.entries(t))i==="className"?a.className=r:a.setAttribute(i,r);for(const i of o)typeof i=="string"?a.appendChild(document.createTextNode(i)):a.appendChild(i);return a}function u(e,t,o=""){const a=s("button",{className:o},e);return a.addEventListener("click",t),a}function Te(){const e=s("span",{className:"status-dot disconnected"}),t=s("span",{className:"status-text"},"Disconnected"),o=s("span",{className:"pos-text"},"X: 0.0  Y: 0.0"),a=u("Connect",async()=>{try{Ne(),await we(),await Fe(),setInterval(()=>J(),1e3)}catch(l){n.log(`[ui] Connect failed: ${l}`)}},"btn-primary btn-sm"),i=u("Disconnect",async()=>{await Ce()},"btn-danger btn-sm"),r=s("div",{className:"connection-controls"},e,t,o,a,i);return n.subscribe(()=>{const{connection:l,machinePosition:d}=n.state;switch(e.className=`status-dot ${l}`,i.disabled=l!==f.Connected,l){case f.Disconnected:t.textContent="Disconnected",a.disabled=!1;break;case f.Connecting:t.textContent="Connecting...",a.disabled=!0;break;case f.Connected:t.textContent="Connected",a.disabled=!0;break;case f.Error:t.textContent="Error",a.disabled=!1;break}o.textContent=`X: ${d.x.toFixed(1)}  Y: ${d.y.toFixed(1)}`}),r}const Ae=[.1,1,5,10];function De(){let e=5;const t=Ae.map(c=>{const p=u(`${c}`,()=>{e=c,o()},c===e?"btn-sm btn-active":"btn-sm");return p.dataset.dist=String(c),p});function o(){for(const c of t)c.className=Number(c.dataset.dist)===e?"btn-sm btn-active":"btn-sm"}const a=s("div",{className:"jog-dist-row"},s("span",{},"Step (mm):"),...t),i=u("Y+",()=>G(0,-e),"btn-jog"),r=u("Y-",()=>G(0,e),"btn-jog"),l=u("X-",()=>G(-e,0),"btn-jog"),d=u("X+",()=>G(e,0),"btn-jog"),m=s("div",{className:"jog-arrows"},s("div",{className:"jog-row"},i),s("div",{className:"jog-row"},l,s("div",{className:"jog-spacer"}),d),s("div",{className:"jog-row"},r)),x=u("Pen Up",()=>V(),"btn-secondary"),N=u("Pen Down",()=>ie(),"btn-secondary"),g=u("Home",()=>_e(),"btn-secondary"),h=u("Unlock",()=>Pe(),"btn-secondary"),P=u("Set Origin",()=>Re(),"btn-secondary"),L=s("span",{className:"pen-indicator"},"UP"),B=s("div",{className:"jog-actions"},s("div",{className:"jog-pen-row"},x,N,s("span",{},"Pen: "),L),s("div",{className:"jog-home-row"},g,h,P)),R=s("section",{className:"panel jog-panel"},s("h2",{},"Manual Controls"),a,m,B),F=[i,r,l,d,x,N,g,h,P];return n.subscribe(()=>{const c=n.state.connection!==f.Connected;for(const p of F)p.disabled=c;L.textContent=n.state.penDown?"DOWN":"UP",L.className=`pen-indicator ${n.state.penDown?"down":"up"}`}),R}function Ee(){const e=new Map,t=s("div",{className:"plate-grid"});t.appendChild(s("div",{className:"plate-header-corner"}));for(let a=0;a<E;a++)t.appendChild(s("div",{className:"plate-col-label"},Q[a]));for(let a=D-1;a>=0;a--){t.appendChild(s("div",{className:"plate-label"},String(a+1)));for(let i=0;i<E;i++){const r=q(i,a),l=s("div",{className:"plate-well pending",title:r},r);e.set(r,l),t.appendChild(l)}}const o=s("section",{className:"panel plate-panel"},s("h2",{},"Plate"),t);return n.subscribe(()=>{const{wellStates:a,currentWell:i}=n.state;for(const[r,l]of e){const d=a.get(r)??j.Pending;l.className=`plate-well ${d}`,r===i&&l.classList.add("current")}}),o}const I=[{step:O.CalibratingA1,label:"A1 (top-left)",wellLabel:"A1"},{step:O.CalibratingA8,label:"A8 (top-right)",wellLabel:"A8"},{step:O.CalibratingF1,label:"F1 (bottom-left)",wellLabel:"F1"}];function Be(){let e=-1;const t={},o=s("p",{className:"cal-instruction"},'Press "Start Calibration" then jog to each corner well.'),a=s("span",{},"---"),i=s("span",{},"---"),r=s("span",{},"---"),l=[a,i,r];function d(c){return c?`(${c.x.toFixed(1)}, ${c.y.toFixed(1)})`:"---"}async function m(c,p){try{n.log(`[cal] Raising tip and moving to ${p}...`),await V();const{feedRate:S}=n.state.runConfig;await z(c,S),n.log(`[cal] Arrived at ${p}`)}catch(S){n.log(`[cal] Move to ${p} failed: ${S}`)}}const x=u("Go To",()=>{const c=n.state.calibration;c&&m(c.a1,"A1")},"btn-secondary btn-sm"),N=u("Go To",()=>{const c=n.state.calibration;c&&m(c.a8,"A8")},"btn-secondary btn-sm"),g=u("Go To",()=>{const c=n.state.calibration;c&&m(c.f1,"F1")},"btn-secondary btn-sm"),h=u("Capture Position",()=>{if(e<0||e>=I.length)return;const c={...n.state.machinePosition},p=I[e];if(p.wellLabel==="A1"&&(t.a1=c),p.wellLabel==="A8"&&(t.a8=c),p.wellLabel==="F1"&&(t.f1=c),l[e].textContent=d(c),n.log(`[cal] Captured ${p.wellLabel} at ${d(c)}`),e++,e>=I.length){const S=t;n.update({calibration:S,calibrationStep:O.Complete}),ue(S),o.textContent="Calibration complete! Positions saved.",h.disabled=!0,n.log("[cal] Calibration saved")}else n.update({calibrationStep:I[e].step}),o.textContent=`Jog to well ${I[e].label}, then press Capture.`},"btn-primary"),P=u("Start Calibration",()=>{e=0,n.update({calibrationStep:I[0].step}),o.textContent=`Jog to well ${I[0].label}, then press Capture.`,h.disabled=!1;for(const c of l)c.textContent="---"},"btn-secondary");h.disabled=!0;const L=s("div",{className:"cal-positions"},s("div",{className:"cal-row"},s("strong",{},"A1: "),a,x),s("div",{className:"cal-row"},s("strong",{},"A8: "),i,N),s("div",{className:"cal-row"},s("strong",{},"F1: "),r,g)),B=s("section",{className:"panel calibration-panel"},s("h2",{},"Calibration"),o,L,s("div",{className:"cal-actions"},P,h)),R=n.state.calibration;R&&(a.textContent=d(R.a1),i.textContent=d(R.a8),r.textContent=d(R.f1),o.textContent="Calibration loaded from saved data.");function F(){const c=n.state.connection===f.Connected,p=n.state.calibration;x.disabled=!c||!p,N.disabled=!c||!p,g.disabled=!c||!p}return n.subscribe(()=>{const c=n.state.connection!==f.Connected;P.disabled=c,c&&(h.disabled=!0),F()}),F(),B}function W(e,t,o,a,i,r){const l=s("input",{type:"number",value:String(t),min:String(o),max:String(a),step:String(i)});return l.addEventListener("change",()=>{const d=parseFloat(l.value);isNaN(d)||(r(d),fe(n.state.runConfig))}),s("div",{className:"config-field"},s("label",{},e),l)}function We(){const e=n.state.runConfig;return s("section",{className:"panel config-panel"},s("h2",{},"Run Configuration"),W("Dwell time (sec)",e.dwellTimeSec,1,3600,1,o=>{n.state.runConfig.dwellTimeSec=o}),W("XY speed (mm/min)",e.feedRate,100,1e4,100,o=>{n.state.runConfig.feedRate=o}),W("Z speed (mm/min)",e.zFeedRate,10,2e3,10,o=>{n.state.runConfig.zFeedRate=o}),W("Z up / raised (mm)",e.penUpValue,0,50,.5,o=>{n.state.runConfig.penUpValue=o}),W("Z down / in well (mm)",e.penDownValue,0,50,.5,o=>{n.state.runConfig.penDownValue=o}))}function Oe(e,t,o){const a=t/(E-1),i=o/(D-1),r={x:e.f1.x+(e.a8.x-e.a1.x),y:e.f1.y+(e.a8.y-e.a1.y)},l=(1-a)*(1-i)*e.a1.x+(1-a)*i*e.a8.x+a*(1-i)*e.f1.x+a*i*r.x,d=(1-a)*(1-i)*e.a1.y+(1-a)*i*e.a8.y+a*(1-i)*e.f1.y+a*i*r.y;return{x:l,y:d}}function je(){const e=[];for(let t=0;t<D;t++)for(let o=0;o<E;o++)e.push({wellId:q(o,t),row:o,col:t});return e}function ke(e){const t=D/(D-1),o=.5,a={x:e.f1.x+(e.a8.x-e.a1.x),y:e.f1.y+(e.a8.y-e.a1.y)},i=(1-o)*(1-t)*e.a1.x+(1-o)*t*e.a8.x+o*(1-t)*e.f1.x+o*t*a.x,r=(1-o)*(1-t)*e.a1.y+(1-o)*t*e.a8.y+o*(1-t)*e.f1.y+o*t*a.y;return{x:i,y:r}}let b=null,A=null,_=null;async function Ge(){const{calibration:e,runConfig:t}=n.state;if(!e){n.log("[runner] Cannot start: no calibration data");return}b=new AbortController,n.resetWells(),n.update({runState:C.Running}),n.log("[runner] Run started");const o=je();try{for(const a of o){if(b.signal.aborted||n.state.runState===C.Paused&&(await Ve(),b.signal.aborted))break;n.state.wellStates.set(a.wellId,j.Active),n.update({currentWell:a.wellId});const i=Oe(e,a.row,a.col);if(n.log("[runner] Raising tip"),await V(),b.signal.aborted||(n.log(`[runner] Moving to ${a.wellId} (${i.x.toFixed(1)}, ${i.y.toFixed(1)})`),await Ie(i),b.signal.aborted)||(n.log(`[runner] Lowering into ${a.wellId}`),await ie(),b.signal.aborted)||(n.log("[runner] Waiting for motion to complete..."),await xe(),b.signal.aborted)||(n.log(`[runner] Dwelling in ${a.wellId} for ${t.dwellTimeSec}s`),await Xe(t.dwellTimeSec),b.signal.aborted))break;n.state.wellStates.set(a.wellId,j.Done),n.update({})}if(!b.signal.aborted){await V();const a=ke(e);n.log(`[runner] Moving to drip-off position (${a.x.toFixed(1)}, ${a.y.toFixed(1)})`),await z(a,t.feedRate),n.update({runState:C.Complete,currentWell:null}),n.log("[runner] Run complete")}}catch(a){n.log(`[runner] Error: ${a}`),n.update({runState:C.Idle})}finally{b=null,_=null}}function Ue(){n.update({runState:C.Paused}),n.log("[runner] Paused")}function Me(){n.update({runState:C.Running}),n.log("[runner] Resumed"),A&&(A(),A=null)}function Ye(){b&&b.abort(),Se(),A&&(A(),A=null),_&&(clearInterval(_),_=null),n.update({runState:C.Idle,dwellRemainingSec:0}),n.log("[runner] Stopped")}function Ve(){return new Promise(e=>{A=e})}function Xe(e){return new Promise(t=>{let o=e;n.update({dwellRemainingSec:o}),_=setInterval(()=>{n.state.runState!==C.Paused&&(o-=1,n.update({dwellRemainingSec:Math.max(0,o)}),o<=0&&(clearInterval(_),_=null,n.update({dwellRemainingSec:0}),t()),b?.signal.aborted&&(clearInterval(_),_=null,t()))},1e3)})}function Je(){const e=u("Start Run",()=>Ge(),"btn-primary btn-lg"),t=u("Pause",()=>Ue(),"btn-secondary"),o=u("Resume",()=>Me(),"btn-primary"),a=u("Stop",()=>Ye(),"btn-danger"),i=s("span",{className:"run-well"},"---"),r=s("span",{className:"run-dwell"},"---"),l=s("span",{className:"run-progress"},"0 / 48"),d=s("div",{className:"progress-bar-fill"}),m=s("div",{className:"progress-bar"},d),x=s("span",{className:"run-status"},"Idle"),N=s("section",{className:"panel run-panel"},s("h2",{},"Run"),s("div",{className:"run-info"},s("div",{},s("strong",{},"Status: "),x),s("div",{},s("strong",{},"Well: "),i),s("div",{},s("strong",{},"Dwell: "),r),s("div",{},s("strong",{},"Progress: "),l)),m,s("div",{className:"run-actions"},e,t,o,a));return n.subscribe(()=>{const{runState:g,currentWell:h,dwellRemainingSec:P,wellStates:L,connection:B,calibration:R}=n.state,F=E*D;let c=0;for(const le of L.values())le===j.Done&&c++;i.textContent=h??"---",r.textContent=P>0?`${P}s`:"---",l.textContent=`${c} / ${F}`,d.style.width=`${c/F*100}%`,x.textContent=g.charAt(0).toUpperCase()+g.slice(1);const p=B===f.Connected,S=R!==null,re=g===C.Idle||g===C.Complete,H=g===C.Running,Z=g===C.Paused;e.style.display=re?"":"none",e.disabled=!p||!S,e.title=S?"":"Calibrate the plate first",t.style.display=H?"":"none",o.style.display=Z?"":"none",a.style.display=H||Z?"":"none"}),N}function qe(){const e=s("div",{className:"console-log"}),t=s("input",{type:"text",placeholder:"Type G-code command...",className:"console-input"}),o=s("button",{className:"btn-primary btn-sm"},"Send");async function a(){const d=t.value.trim();if(d){t.value="";try{await v(d)}catch(m){n.log(`[console] Error: ${m}`)}}}o.addEventListener("click",a),t.addEventListener("keydown",d=>{d.key==="Enter"&&a()});const i=s("div",{className:"console-input-row"},t,o),r=s("section",{className:"panel console-panel"},s("h2",{},"Console"),e,i);let l=0;return n.subscribe(()=>{const{consoleLog:d,connection:m}=n.state,x=m!==f.Connected;if(t.disabled=x,o.disabled=x,d.length!==l){const N=d.slice(l);for(const g of N){const h=s("div",{className:`console-line ${g.startsWith(">")?"sent":g.startsWith("<")?"received":"info"}`},g);e.appendChild(h)}l=d.length,e.scrollTop=e.scrollHeight}}),r}function ze(){const e=pe(),t=ge();if(n.update({calibration:e,runConfig:t}),!("serial"in navigator)){document.querySelector("#app").innerHTML=`
      <div class="unsupported">
        <h1>Browser Not Supported</h1>
        <p>This app requires the <strong>Web Serial API</strong>, which is only available in
           <strong>Chrome/Edge 89+</strong>.</p>
        <p>Please open this page in Chrome or Edge.</p>
      </div>
    `;return}const o=document.querySelector("#app"),a=s("pre",{className:"ascii-logo"},`  ___  ___ ___ ___   ___      _
 / __|/ __|_ _/ __| | _ ) ___| |_
| (_ |\\__ \\| |\\__ \\ | _ \\/ _ \\  _|
 \\___|___/___|___/ |___/\\___/\\__|`),i=s("header",{className:"app-header"},a,s("span",{className:"app-subtitle"},"48-Well Plate Controller"),Te()),r=s("div",{className:"col col-left"},Ee(),Je(),Be()),l=s("div",{className:"col col-right"},De(),qe(),We()),d=s("div",{className:"main-layout"},r,l);o.appendChild(i),o.appendChild(d)}ze();
