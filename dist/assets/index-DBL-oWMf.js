(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}})();const B={Pending:"pending",Active:"active",Done:"done",Skipped:"skipped"},I=6,W=8,q=["A","B","C","D","E","F"];function V(e,t){return`${q[e]}${t+1}`}const f={Disconnected:"disconnected",Connecting:"connecting",Connected:"connected",Error:"error"},g={Idle:"idle",Running:"running",Paused:"paused",Complete:"complete"},A={None:"none",CalibratingA1:"a1",CalibratingA8:"a8",CalibratingF1:"f1",Complete:"complete"},k={dwellTimeSec:120,feedRate:3e3,penUpValue:0,penDownValue:1e3,penMovePause:.5};function H(){const e=new Map;for(let t=0;t<I;t++)for(let o=0;o<W;o++)e.set(V(t,o),B.Pending);return e}function ae(){return{connection:f.Disconnected,machinePosition:{x:0,y:0},penDown:!1,calibration:null,calibrationStep:A.None,runConfig:{...k},runState:g.Idle,currentWell:null,wellStates:H(),dwellRemainingSec:0,consoleLog:[]}}class oe{state=ae();listeners=new Set;subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}update(t){Object.assign(this.state,t),this.notify()}log(t){this.state.consoleLog.push(t),this.state.consoleLog.length>500&&(this.state.consoleLog=this.state.consoleLog.slice(-500)),this.notify()}resetWells(){this.state.wellStates=H(),this.state.currentWell=null,this.state.dwellRemainingSec=0,this.notify()}notify(){for(const t of this.listeners)t()}}const a=new oe,K="gsis-bot:calibration",Q="gsis-bot:config";function se(e){localStorage.setItem(K,JSON.stringify(e))}function ie(){const e=localStorage.getItem(K);if(!e)return null;try{return JSON.parse(e)}catch{return null}}function le(e){localStorage.setItem(Q,JSON.stringify(e))}function re(){const e=localStorage.getItem(Q);if(!e)return{...k};try{return{...k,...JSON.parse(e)}}catch{return{...k}}}let h=null,P=null,L=null,M=!1,z=null;const ce=new TextEncoder,X=115200;function ue(e){z=e}async function de(){if(h)throw new Error("Already connected");a.update({connection:f.Connecting});try{if(h=await navigator.serial.requestPort(),await h.open({baudRate:X}),!h.readable||!h.writable)throw new Error("Port is not readable/writable");P=h.readable.getReader(),L=h.writable.getWriter(),a.update({connection:f.Connected}),a.log(`[serial] Connected at ${X} baud`),M=!0,fe()}catch(e){throw h=null,P=null,L=null,a.update({connection:f.Error}),a.log(`[serial] Connection failed: ${e}`),e}}async function pe(){M=!1;try{P&&(await P.cancel(),P.releaseLock(),P=null),L&&(L.releaseLock(),L=null),h&&(await h.close(),h=null)}catch{}a.update({connection:f.Disconnected}),a.log("[serial] Disconnected")}async function Z(e){if(!L)throw new Error("Not connected");const t=ce.encode(e+`
`);await L.write(t),a.log(`> ${e}`)}function ee(){return h!==null&&a.state.connection===f.Connected}async function fe(){let e="";const t=new TextDecoder;for(;M&&P;)try{const{value:o,done:s}=await P.read();if(s)break;e+=t.decode(o,{stream:!0});const i=e.split(`
`);e=i.pop()??"";for(const l of i){const r=l.replace(/\r/g,"").trim();r.length>0&&(a.log(`< ${r}`),z?.(r))}}catch(o){M&&(a.log(`[serial] Read error: ${o}`),a.update({connection:f.Error}));break}}const F=[];let C=null;function ge(e){if(e.startsWith("<")&&e.endsWith(">")){const t=me(e);t&&a.update({machinePosition:{x:t.mpos.x,y:t.mpos.y}});return}if(e.startsWith("Grbl")){a.log(`[grbl] Controller ready: ${e}`);return}if(C){e==="ok"?(C.resolve("ok"),C=null,U()):e.startsWith("error")&&(C.reject(new Error(e)),C=null,U());return}}function me(e){const o=e.slice(1,-1).split("|"),s=o[0];let i={x:0,y:0,z:0};for(const l of o)if(l.startsWith("MPos:")){const r=l.slice(5).split(",").map(Number);i={x:r[0]??0,y:r[1]??0,z:r[2]??0}}return{state:s,mpos:i}}function U(){C||F.length===0||ee()&&(C=F.shift(),Z(C.command).catch(e=>{C?.reject(e),C=null}))}function m(e){return new Promise((t,o)=>{F.push({command:e,resolve:t,reject:o}),U()})}function be(){ee()&&Z("?").catch(()=>{})}function we(){ue(ge)}function Ce(){for(const e of F)e.reject(new Error("Queue cleared"));F.length=0,C&&(C.reject(new Error("Queue cleared")),C=null)}async function he(e,t){await m(`G1 X${e.x.toFixed(3)} Y${e.y.toFixed(3)} F${t}`)}async function O(e,t){await m("G91"),await m(`G0 X${e.toFixed(3)} Y${t.toFixed(3)}`),await m("G90")}async function Y(){const{penUpValue:e,penMovePause:t}=a.state.runConfig;await m(`M3 S${e}`),await m(`G4 P${t}`),a.update({penDown:!1})}async function te(){const{penDownValue:e,penMovePause:t}=a.state.runConfig;await m(`M3 S${e}`),await m(`G4 P${t}`),a.update({penDown:!0})}async function ye(){await m("$H")}async function ve(){await m("$X")}async function Se(){await m("G10 L20 P1 X0 Y0")}async function Ne(){await m("G90")}async function xe(){await m("G21")}async function _e(){await new Promise(e=>setTimeout(e,1500)),await Ne(),await xe()}async function Pe(e){const{feedRate:t}=a.state.runConfig;await Y(),await he(e,t),await te()}function n(e,t,...o){const s=document.createElement(e);if(t)for(const[i,l]of Object.entries(t))i==="className"?s.className=l:s.setAttribute(i,l);for(const i of o)typeof i=="string"?s.appendChild(document.createTextNode(i)):s.appendChild(i);return s}function d(e,t,o=""){const s=n("button",{className:o},e);return s.addEventListener("click",t),s}function Re(){const e=n("span",{className:"status-dot disconnected"}),t=n("span",{className:"status-text"},"Disconnected"),o=n("span",{className:"pos-text"},"X: 0.0  Y: 0.0"),s=d("Connect",async()=>{try{we(),await de(),await _e(),setInterval(()=>be(),1e3)}catch(r){a.log(`[ui] Connect failed: ${r}`)}},"btn-primary btn-sm"),i=d("Disconnect",async()=>{await pe()},"btn-danger btn-sm"),l=n("section",{className:"panel connection-panel"},e,t,o,s,i);return a.subscribe(()=>{const{connection:r,machinePosition:c}=a.state;switch(e.className=`status-dot ${r}`,i.disabled=r!==f.Connected,r){case f.Disconnected:t.textContent="Disconnected",s.disabled=!1;break;case f.Connecting:t.textContent="Connecting...",s.disabled=!0;break;case f.Connected:t.textContent="Connected",s.disabled=!0;break;case f.Error:t.textContent="Error",s.disabled=!1;break}o.textContent=`X: ${c.x.toFixed(1)}  Y: ${c.y.toFixed(1)}`}),l}const Le=[.1,1,5,10];function $e(){let e=5;const t=Le.map(w=>{const E=d(`${w}`,()=>{e=w,o()},w===e?"btn-sm btn-active":"btn-sm");return E.dataset.dist=String(w),E});function o(){for(const w of t)w.className=Number(w.dataset.dist)===e?"btn-sm btn-active":"btn-sm"}const s=n("div",{className:"jog-dist-row"},n("span",{},"Step (mm):"),...t),i=d("Y+",()=>O(0,-e),"btn-jog"),l=d("Y-",()=>O(0,e),"btn-jog"),r=d("X-",()=>O(-e,0),"btn-jog"),c=d("X+",()=>O(e,0),"btn-jog"),b=n("div",{className:"jog-arrows"},n("div",{className:"jog-row"},i),n("div",{className:"jog-row"},r,n("div",{className:"jog-spacer"}),c),n("div",{className:"jog-row"},l)),y=d("Pen Up",()=>Y(),"btn-secondary"),_=d("Pen Down",()=>te(),"btn-secondary"),p=d("Home",()=>ye(),"btn-secondary"),v=d("Unlock",()=>ve(),"btn-secondary"),u=d("Set Origin",()=>Se(),"btn-secondary"),S=n("span",{className:"pen-indicator"},"UP"),D=n("div",{className:"jog-actions"},n("div",{className:"jog-pen-row"},y,_,n("span",{},"Pen: "),S),n("div",{className:"jog-home-row"},p,v,u)),G=n("section",{className:"panel jog-panel"},n("h2",{},"Manual Controls"),s,b,D),j=[i,l,r,c,y,_,p,v,u];return a.subscribe(()=>{const w=a.state.connection!==f.Connected;for(const E of j)E.disabled=w;S.textContent=a.state.penDown?"DOWN":"UP",S.className=`pen-indicator ${a.state.penDown?"down":"up"}`}),G}function De(){const e=new Map,t=n("div",{className:"plate-grid"});t.appendChild(n("div",{className:"plate-header-corner"}));for(let s=0;s<I;s++)t.appendChild(n("div",{className:"plate-col-label"},q[s]));for(let s=W-1;s>=0;s--){t.appendChild(n("div",{className:"plate-label"},String(s+1)));for(let i=0;i<I;i++){const l=V(i,s),r=n("div",{className:"plate-well pending",title:l},l);e.set(l,r),t.appendChild(r)}}const o=n("section",{className:"panel plate-panel"},n("h2",{},"Plate"),t);return a.subscribe(()=>{const{wellStates:s,currentWell:i}=a.state;for(const[l,r]of e){const c=s.get(l)??B.Pending;r.className=`plate-well ${c}`,l===i&&r.classList.add("current")}}),o}const R=[{step:A.CalibratingA1,label:"A1 (top-left)",wellLabel:"A1"},{step:A.CalibratingA8,label:"A8 (top-right)",wellLabel:"A8"},{step:A.CalibratingF1,label:"F1 (bottom-left)",wellLabel:"F1"}];function Ee(){let e=-1;const t={},o=n("p",{className:"cal-instruction"},'Press "Start Calibration" then jog to each corner well.'),s=n("span",{},"---"),i=n("span",{},"---"),l=n("span",{},"---"),r=[s,i,l];function c(u){return u?`(${u.x.toFixed(1)}, ${u.y.toFixed(1)})`:"---"}const b=d("Capture Position",()=>{if(e<0||e>=R.length)return;const u={...a.state.machinePosition},S=R[e];if(S.wellLabel==="A1"&&(t.a1=u),S.wellLabel==="A8"&&(t.a8=u),S.wellLabel==="F1"&&(t.f1=u),r[e].textContent=c(u),a.log(`[cal] Captured ${S.wellLabel} at ${c(u)}`),e++,e>=R.length){const D=t;a.update({calibration:D,calibrationStep:A.Complete}),se(D),o.textContent="Calibration complete! Positions saved.",b.disabled=!0,a.log("[cal] Calibration saved")}else a.update({calibrationStep:R[e].step}),o.textContent=`Jog to well ${R[e].label}, then press Capture.`},"btn-primary"),y=d("Start Calibration",()=>{e=0,a.update({calibrationStep:R[0].step}),o.textContent=`Jog to well ${R[0].label}, then press Capture.`,b.disabled=!1;for(const u of r)u.textContent="---"},"btn-secondary");b.disabled=!0;const _=n("div",{className:"cal-positions"},n("div",{},n("strong",{},"A1: "),s),n("div",{},n("strong",{},"A8: "),i),n("div",{},n("strong",{},"F1: "),l)),p=n("section",{className:"panel calibration-panel"},n("h2",{},"Calibration"),o,_,n("div",{className:"cal-actions"},y,b)),v=a.state.calibration;return v&&(s.textContent=c(v.a1),i.textContent=c(v.a8),l.textContent=c(v.f1),o.textContent="Calibration loaded from saved data."),a.subscribe(()=>{const u=a.state.connection!==f.Connected;y.disabled=u,u&&(b.disabled=!0)}),p}function T(e,t,o,s,i,l){const r=n("input",{type:"number",value:String(t),min:String(o),max:String(s),step:String(i)});return r.addEventListener("change",()=>{const c=parseFloat(r.value);isNaN(c)||(l(c),le(a.state.runConfig))}),n("div",{className:"config-field"},n("label",{},e),r)}function Ie(){const e=a.state.runConfig;return n("section",{className:"panel config-panel"},n("h2",{},"Run Configuration"),T("Dwell time (sec)",e.dwellTimeSec,1,3600,1,o=>{a.state.runConfig.dwellTimeSec=o}),T("Feed rate (mm/min)",e.feedRate,100,1e4,100,o=>{a.state.runConfig.feedRate=o}),T("Pen up value",e.penUpValue,0,1e3,10,o=>{a.state.runConfig.penUpValue=o}),T("Pen down value",e.penDownValue,0,1e3,10,o=>{a.state.runConfig.penDownValue=o}),T("Pen move pause (sec)",e.penMovePause,0,5,.1,o=>{a.state.runConfig.penMovePause=o}))}function Te(e,t,o){const s=t/(I-1),i=o/(W-1),l={x:e.f1.x+(e.a8.x-e.a1.x),y:e.f1.y+(e.a8.y-e.a1.y)},r=(1-s)*(1-i)*e.a1.x+(1-s)*i*e.a8.x+s*(1-i)*e.f1.x+s*i*l.x,c=(1-s)*(1-i)*e.a1.y+(1-s)*i*e.a8.y+s*(1-i)*e.f1.y+s*i*l.y;return{x:r,y:c}}function Ae(){const e=[];for(let t=0;t<I;t++)for(let o=0;o<W;o++)e.push({wellId:V(t,o),row:t,col:o});return e}let N=null,$=null,x=null;async function Be(){const{calibration:e,runConfig:t}=a.state;if(!e){a.log("[runner] Cannot start: no calibration data");return}N=new AbortController,a.resetWells(),a.update({runState:g.Running}),a.log("[runner] Run started");const o=Ae();try{for(const s of o){if(N.signal.aborted||a.state.runState===g.Paused&&(await Oe(),N.signal.aborted))break;a.state.wellStates.set(s.wellId,B.Active),a.update({currentWell:s.wellId});const i=Te(e,s.row,s.col);if(a.log(`[runner] Moving to ${s.wellId} (${i.x.toFixed(1)}, ${i.y.toFixed(1)})`),await Pe(i),N.signal.aborted||(a.log(`[runner] Dwelling in ${s.wellId} for ${t.dwellTimeSec}s`),await ke(t.dwellTimeSec),N.signal.aborted))break;a.state.wellStates.set(s.wellId,B.Done),a.update({})}N.signal.aborted||(await Y(),a.update({runState:g.Complete,currentWell:null}),a.log("[runner] Run complete"))}catch(s){a.log(`[runner] Error: ${s}`),a.update({runState:g.Idle})}finally{N=null,x=null}}function Fe(){a.update({runState:g.Paused}),a.log("[runner] Paused")}function We(){a.update({runState:g.Running}),a.log("[runner] Resumed"),$&&($(),$=null)}function je(){N&&N.abort(),Ce(),$&&($(),$=null),x&&(clearInterval(x),x=null),a.update({runState:g.Idle,dwellRemainingSec:0}),a.log("[runner] Stopped")}function Oe(){return new Promise(e=>{$=e})}function ke(e){return new Promise(t=>{let o=e;a.update({dwellRemainingSec:o}),x=setInterval(()=>{a.state.runState!==g.Paused&&(o-=1,a.update({dwellRemainingSec:Math.max(0,o)}),o<=0&&(clearInterval(x),x=null,a.update({dwellRemainingSec:0}),t()),N?.signal.aborted&&(clearInterval(x),x=null,t()))},1e3)})}function Me(){const e=d("Start Run",()=>Be(),"btn-primary btn-lg"),t=d("Pause",()=>Fe(),"btn-secondary"),o=d("Resume",()=>We(),"btn-primary"),s=d("Stop",()=>je(),"btn-danger"),i=n("span",{className:"run-well"},"---"),l=n("span",{className:"run-dwell"},"---"),r=n("span",{className:"run-progress"},"0 / 48"),c=n("div",{className:"progress-bar-fill"}),b=n("div",{className:"progress-bar"},c),y=n("span",{className:"run-status"},"Idle"),_=n("section",{className:"panel run-panel"},n("h2",{},"Run"),n("div",{className:"run-info"},n("div",{},n("strong",{},"Status: "),y),n("div",{},n("strong",{},"Current Well: "),i),n("div",{},n("strong",{},"Dwell Remaining: "),l),n("div",{},n("strong",{},"Progress: "),r)),b,n("div",{className:"run-actions"},e,t,o,s));return a.subscribe(()=>{const{runState:p,currentWell:v,dwellRemainingSec:u,wellStates:S,connection:D,calibration:G}=a.state,j=I*W;let w=0;for(const ne of S.values())ne===B.Done&&w++;i.textContent=v??"---",l.textContent=u>0?`${u}s`:"---",r.textContent=`${w} / ${j}`,c.style.width=`${w/j*100}%`,y.textContent=p.charAt(0).toUpperCase()+p.slice(1);const E=D===f.Connected,J=G!==null;e.style.display=p===g.Idle||p===g.Complete?"":"none",e.disabled=!E||!J,J?e.title="":e.title="Calibrate the plate first",t.style.display=p===g.Running?"":"none",o.style.display=p===g.Paused?"":"none",s.style.display=p===g.Running||p===g.Paused?"":"none"}),_}function Ge(){const e=n("div",{className:"console-log"}),t=n("input",{type:"text",placeholder:"Type G-code command...",className:"console-input"}),o=n("button",{className:"btn-primary btn-sm"},"Send");async function s(){const c=t.value.trim();if(c){t.value="";try{await m(c)}catch(b){a.log(`[console] Error: ${b}`)}}}o.addEventListener("click",s),t.addEventListener("keydown",c=>{c.key==="Enter"&&s()});const i=n("div",{className:"console-input-row"},t,o),l=n("section",{className:"panel console-panel"},n("h2",{},"Console"),e,i);let r=0;return a.subscribe(()=>{const{consoleLog:c,connection:b}=a.state,y=b!==f.Connected;if(t.disabled=y,o.disabled=y,c.length!==r){const _=c.slice(r);for(const p of _){const v=n("div",{className:`console-line ${p.startsWith(">")?"sent":p.startsWith("<")?"received":"info"}`},p);e.appendChild(v)}r=c.length,e.scrollTop=e.scrollHeight}}),l}function Ue(){const e=ie(),t=re();if(a.update({calibration:e,runConfig:t}),!("serial"in navigator)){document.querySelector("#app").innerHTML=`
      <div class="unsupported">
        <h1>Browser Not Supported</h1>
        <p>This app requires the <strong>Web Serial API</strong>, which is only available in
           <strong>Chrome/Edge 89+</strong>.</p>
        <p>Please open this page in Chrome or Edge.</p>
      </div>
    `;return}const o=document.querySelector("#app"),s=n("pre",{className:"ascii-logo"},`  ___  ___ ___ ___   ___      _
 / __|/ __|_ _/ __| | _ ) ___| |_
| (_ |\\__ \\| |\\__ \\ | _ \\/ _ \\  _|
 \\___|___/___|___/ |___/\\___/\\__|`),i=n("header",{className:"app-header"},s,n("span",{className:"app-subtitle"},"48-Well Plate Controller")),l=n("div",{className:"col col-left"},Re(),De(),Me(),$e()),r=n("div",{className:"col col-right"},Ee(),Ie(),Ge()),c=n("div",{className:"main-layout"},l,r);o.appendChild(i),o.appendChild(c)}Ue();
