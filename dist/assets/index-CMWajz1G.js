(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function a(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=a(i);fetch(i.href,r)}})();const F={Pending:"pending",Active:"active",Done:"done",Skipped:"skipped"},T=6,D=8,Z=["A","B","C","D","E","F"];function V(e,t){return`${Z[e]}${t+1}`}const p={Disconnected:"disconnected",Connecting:"connecting",Connected:"connected",Error:"error"},w={Idle:"idle",Running:"running",Paused:"paused",Complete:"complete"},A={None:"none",CalibratingA1:"a1",CalibratingA8:"a8",CalibratingF1:"f1",Complete:"complete"},k={dwellTimeSec:120,feedRate:3e3,penUpValue:0,penDownValue:7};function K(){const e=new Map;for(let t=0;t<T;t++)for(let a=0;a<D;a++)e.set(V(t,a),F.Pending);return e}function re(){return{connection:p.Disconnected,machinePosition:{x:0,y:0},penDown:!1,calibration:null,calibrationStep:A.None,runConfig:{...k},runState:w.Idle,currentWell:null,wellStates:K(),dwellRemainingSec:0,consoleLog:[]}}class le{state=re();listeners=new Set;subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}update(t){Object.assign(this.state,t),this.notify()}log(t){this.state.consoleLog.push(t),this.state.consoleLog.length>500&&(this.state.consoleLog=this.state.consoleLog.slice(-500)),this.notify()}resetWells(){this.state.wellStates=K(),this.state.currentWell=null,this.state.dwellRemainingSec=0,this.notify()}notify(){for(const t of this.listeners)t()}}const o=new le,Q="gsis-bot:calibration",z="gsis-bot:config";function ce(e){localStorage.setItem(Q,JSON.stringify(e))}function ue(){const e=localStorage.getItem(Q);if(!e)return null;try{return JSON.parse(e)}catch{return null}}function de(e){localStorage.setItem(z,JSON.stringify(e))}function pe(){const e=localStorage.getItem(z);if(!e)return{...k};try{return{...k,...JSON.parse(e)}}catch{return{...k}}}let C=null,P=null,L=null,G=!1,ee=null;const fe=new TextEncoder,H=115200;function ge(e){ee=e}async function me(){if(C)throw new Error("Already connected");o.update({connection:p.Connecting});try{if(C=await navigator.serial.requestPort(),await C.open({baudRate:H}),!C.readable||!C.writable)throw new Error("Port is not readable/writable");P=C.readable.getReader(),L=C.writable.getWriter(),o.update({connection:p.Connected}),o.log(`[serial] Connected at ${H} baud`),G=!0,we()}catch(e){throw C=null,P=null,L=null,o.update({connection:p.Error}),o.log(`[serial] Connection failed: ${e}`),e}}async function be(){G=!1;try{P&&(await P.cancel(),P.releaseLock(),P=null),L&&(L.releaseLock(),L=null),C&&(await C.close(),C=null)}catch{}o.update({connection:p.Disconnected}),o.log("[serial] Disconnected")}async function te(e){if(!L)throw new Error("Not connected");const t=fe.encode(e+`
`);await L.write(t),o.log(`> ${e}`)}function ne(){return C!==null&&o.state.connection===p.Connected}async function we(){let e="";const t=new TextDecoder;for(;G&&P;)try{const{value:a,done:s}=await P.read();if(s)break;e+=t.decode(a,{stream:!0});const i=e.split(`
`);e=i.pop()??"";for(const r of i){const l=r.replace(/\r/g,"").trim();l.length>0&&(o.log(`< ${l}`),ee?.(l))}}catch(a){G&&(o.log(`[serial] Read error: ${a}`),o.update({connection:p.Error}));break}}const B=[];let b=null;function Ce(e){if(e.startsWith("<")&&e.endsWith(">")){const t=he(e);t&&o.update({machinePosition:{x:t.mpos.x,y:t.mpos.y}});return}if(e.startsWith("Grbl")){o.log(`[grbl] Controller ready: ${e}`);return}if(b){e==="ok"?(b.resolve("ok"),b=null,M()):e.startsWith("error")&&(b.reject(new Error(e)),b=null,M());return}}function he(e){const a=e.slice(1,-1).split("|"),s=a[0];let i={x:0,y:0,z:0};for(const r of a)if(r.startsWith("MPos:")){const l=r.slice(5).split(",").map(Number);i={x:l[0]??0,y:l[1]??0,z:l[2]??0}}return{state:s,mpos:i}}function M(){b||B.length===0||ne()&&(b=B.shift(),te(b.command).catch(e=>{b?.reject(e),b=null}))}function h(e){return new Promise((t,a)=>{B.push({command:e,resolve:t,reject:a}),M()})}function ye(){ne()&&te("?").catch(()=>{})}function xe(){ge(Ce)}function ve(){for(const e of B)e.reject(new Error("Queue cleared"));B.length=0,b&&(b.reject(new Error("Queue cleared")),b=null)}async function oe(e,t){await h(`G1 X${e.x.toFixed(3)} Y${e.y.toFixed(3)} F${t}`)}async function O(e,t){await h("G91"),await h(`G0 X${e.toFixed(3)} Y${t.toFixed(3)}`),await h("G90")}async function Y(){const{penUpValue:e}=o.state.runConfig;await h(`G0 Z${e}`),o.update({penDown:!1})}async function ae(){const{penDownValue:e}=o.state.runConfig;await h(`G0 Z${e}`),o.update({penDown:!0})}async function Se(){await h("$H")}async function Ne(){await h("$X")}async function _e(){await h("G10 L20 P1 X0 Y0")}async function Pe(){await h("G90")}async function Re(){await h("G21")}async function Le(){await new Promise(e=>setTimeout(e,1500)),await Pe(),await Re()}async function $e(e){const{feedRate:t}=o.state.runConfig;await Y(),await oe(e,t),await ae()}function n(e,t,...a){const s=document.createElement(e);if(t)for(const[i,r]of Object.entries(t))i==="className"?s.className=r:s.setAttribute(i,r);for(const i of a)typeof i=="string"?s.appendChild(document.createTextNode(i)):s.appendChild(i);return s}function d(e,t,a=""){const s=n("button",{className:a},e);return s.addEventListener("click",t),s}function De(){const e=n("span",{className:"status-dot disconnected"}),t=n("span",{className:"status-text"},"Disconnected"),a=n("span",{className:"pos-text"},"X: 0.0  Y: 0.0"),s=d("Connect",async()=>{try{xe(),await me(),await Le(),setInterval(()=>ye(),1e3)}catch(l){o.log(`[ui] Connect failed: ${l}`)}},"btn-primary btn-sm"),i=d("Disconnect",async()=>{await be()},"btn-danger btn-sm"),r=n("section",{className:"panel connection-panel"},e,t,a,s,i);return o.subscribe(()=>{const{connection:l,machinePosition:c}=o.state;switch(e.className=`status-dot ${l}`,i.disabled=l!==p.Connected,l){case p.Disconnected:t.textContent="Disconnected",s.disabled=!1;break;case p.Connecting:t.textContent="Connecting...",s.disabled=!0;break;case p.Connected:t.textContent="Connected",s.disabled=!0;break;case p.Error:t.textContent="Error",s.disabled=!1;break}a.textContent=`X: ${c.x.toFixed(1)}  Y: ${c.y.toFixed(1)}`}),r}const Ie=[.1,1,5,10];function Ee(){let e=5;const t=Ie.map(m=>{const E=d(`${m}`,()=>{e=m,a()},m===e?"btn-sm btn-active":"btn-sm");return E.dataset.dist=String(m),E});function a(){for(const m of t)m.className=Number(m.dataset.dist)===e?"btn-sm btn-active":"btn-sm"}const s=n("div",{className:"jog-dist-row"},n("span",{},"Step (mm):"),...t),i=d("Y+",()=>O(0,-e),"btn-jog"),r=d("Y-",()=>O(0,e),"btn-jog"),l=d("X-",()=>O(-e,0),"btn-jog"),c=d("X+",()=>O(e,0),"btn-jog"),g=n("div",{className:"jog-arrows"},n("div",{className:"jog-row"},i),n("div",{className:"jog-row"},l,n("div",{className:"jog-spacer"}),c),n("div",{className:"jog-row"},r)),y=d("Pen Up",()=>Y(),"btn-secondary"),_=d("Pen Down",()=>ae(),"btn-secondary"),f=d("Home",()=>Se(),"btn-secondary"),x=d("Unlock",()=>Ne(),"btn-secondary"),u=d("Set Origin",()=>_e(),"btn-secondary"),v=n("span",{className:"pen-indicator"},"UP"),I=n("div",{className:"jog-actions"},n("div",{className:"jog-pen-row"},y,_,n("span",{},"Pen: "),v),n("div",{className:"jog-home-row"},f,x,u)),U=n("section",{className:"panel jog-panel"},n("h2",{},"Manual Controls"),s,g,I),W=[i,r,l,c,y,_,f,x,u];return o.subscribe(()=>{const m=o.state.connection!==p.Connected;for(const E of W)E.disabled=m;v.textContent=o.state.penDown?"DOWN":"UP",v.className=`pen-indicator ${o.state.penDown?"down":"up"}`}),U}function Te(){const e=new Map,t=n("div",{className:"plate-grid"});t.appendChild(n("div",{className:"plate-header-corner"}));for(let s=0;s<T;s++)t.appendChild(n("div",{className:"plate-col-label"},Z[s]));for(let s=D-1;s>=0;s--){t.appendChild(n("div",{className:"plate-label"},String(s+1)));for(let i=0;i<T;i++){const r=V(i,s),l=n("div",{className:"plate-well pending",title:r},r);e.set(r,l),t.appendChild(l)}}const a=n("section",{className:"panel plate-panel"},n("h2",{},"Plate"),t);return o.subscribe(()=>{const{wellStates:s,currentWell:i}=o.state;for(const[r,l]of e){const c=s.get(r)??F.Pending;l.className=`plate-well ${c}`,r===i&&l.classList.add("current")}}),a}const R=[{step:A.CalibratingA1,label:"A1 (top-left)",wellLabel:"A1"},{step:A.CalibratingA8,label:"A8 (top-right)",wellLabel:"A8"},{step:A.CalibratingF1,label:"F1 (bottom-left)",wellLabel:"F1"}];function Ae(){let e=-1;const t={},a=n("p",{className:"cal-instruction"},'Press "Start Calibration" then jog to each corner well.'),s=n("span",{},"---"),i=n("span",{},"---"),r=n("span",{},"---"),l=[s,i,r];function c(u){return u?`(${u.x.toFixed(1)}, ${u.y.toFixed(1)})`:"---"}const g=d("Capture Position",()=>{if(e<0||e>=R.length)return;const u={...o.state.machinePosition},v=R[e];if(v.wellLabel==="A1"&&(t.a1=u),v.wellLabel==="A8"&&(t.a8=u),v.wellLabel==="F1"&&(t.f1=u),l[e].textContent=c(u),o.log(`[cal] Captured ${v.wellLabel} at ${c(u)}`),e++,e>=R.length){const I=t;o.update({calibration:I,calibrationStep:A.Complete}),ce(I),a.textContent="Calibration complete! Positions saved.",g.disabled=!0,o.log("[cal] Calibration saved")}else o.update({calibrationStep:R[e].step}),a.textContent=`Jog to well ${R[e].label}, then press Capture.`},"btn-primary"),y=d("Start Calibration",()=>{e=0,o.update({calibrationStep:R[0].step}),a.textContent=`Jog to well ${R[0].label}, then press Capture.`,g.disabled=!1;for(const u of l)u.textContent="---"},"btn-secondary");g.disabled=!0;const _=n("div",{className:"cal-positions"},n("div",{},n("strong",{},"A1: "),s),n("div",{},n("strong",{},"A8: "),i),n("div",{},n("strong",{},"F1: "),r)),f=n("section",{className:"panel calibration-panel"},n("h2",{},"Calibration"),a,_,n("div",{className:"cal-actions"},y,g)),x=o.state.calibration;return x&&(s.textContent=c(x.a1),i.textContent=c(x.a8),r.textContent=c(x.f1),a.textContent="Calibration loaded from saved data."),o.subscribe(()=>{const u=o.state.connection!==p.Connected;y.disabled=u,u&&(g.disabled=!0)}),f}function j(e,t,a,s,i,r){const l=n("input",{type:"number",value:String(t),min:String(a),max:String(s),step:String(i)});return l.addEventListener("change",()=>{const c=parseFloat(l.value);isNaN(c)||(r(c),de(o.state.runConfig))}),n("div",{className:"config-field"},n("label",{},e),l)}function Fe(){const e=o.state.runConfig;return n("section",{className:"panel config-panel"},n("h2",{},"Run Configuration"),j("Dwell time (sec)",e.dwellTimeSec,1,3600,1,a=>{o.state.runConfig.dwellTimeSec=a}),j("Feed rate (mm/min)",e.feedRate,100,1e4,100,a=>{o.state.runConfig.feedRate=a}),j("Z up / raised (mm)",e.penUpValue,0,50,.5,a=>{o.state.runConfig.penUpValue=a}),j("Z down / in well (mm)",e.penDownValue,0,50,.5,a=>{o.state.runConfig.penDownValue=a}))}function Be(e,t,a){const s=t/(T-1),i=a/(D-1),r={x:e.f1.x+(e.a8.x-e.a1.x),y:e.f1.y+(e.a8.y-e.a1.y)},l=(1-s)*(1-i)*e.a1.x+(1-s)*i*e.a8.x+s*(1-i)*e.f1.x+s*i*r.x,c=(1-s)*(1-i)*e.a1.y+(1-s)*i*e.a8.y+s*(1-i)*e.f1.y+s*i*r.y;return{x:l,y:c}}function We(){const e=[];for(let t=0;t<D;t++)for(let a=0;a<T;a++)e.push({wellId:V(a,t),row:a,col:t});return e}function Oe(e){const t=D/(D-1),a=.5,s={x:e.f1.x+(e.a8.x-e.a1.x),y:e.f1.y+(e.a8.y-e.a1.y)},i=(1-a)*(1-t)*e.a1.x+(1-a)*t*e.a8.x+a*(1-t)*e.f1.x+a*t*s.x,r=(1-a)*(1-t)*e.a1.y+(1-a)*t*e.a8.y+a*(1-t)*e.f1.y+a*t*s.y;return{x:i,y:r}}let S=null,$=null,N=null;async function je(){const{calibration:e,runConfig:t}=o.state;if(!e){o.log("[runner] Cannot start: no calibration data");return}S=new AbortController,o.resetWells(),o.update({runState:w.Running}),o.log("[runner] Run started");const a=We();try{for(const s of a){if(S.signal.aborted||o.state.runState===w.Paused&&(await Me(),S.signal.aborted))break;o.state.wellStates.set(s.wellId,F.Active),o.update({currentWell:s.wellId});const i=Be(e,s.row,s.col);if(o.log(`[runner] Moving to ${s.wellId} (${i.x.toFixed(1)}, ${i.y.toFixed(1)})`),await $e(i),S.signal.aborted||(o.log(`[runner] Dwelling in ${s.wellId} for ${t.dwellTimeSec}s`),await Ve(t.dwellTimeSec),S.signal.aborted))break;o.state.wellStates.set(s.wellId,F.Done),o.update({})}if(!S.signal.aborted){await Y();const s=Oe(e);o.log(`[runner] Moving to drip-off position (${s.x.toFixed(1)}, ${s.y.toFixed(1)})`),await oe(s,t.feedRate),o.update({runState:w.Complete,currentWell:null}),o.log("[runner] Run complete")}}catch(s){o.log(`[runner] Error: ${s}`),o.update({runState:w.Idle})}finally{S=null,N=null}}function ke(){o.update({runState:w.Paused}),o.log("[runner] Paused")}function Ge(){o.update({runState:w.Running}),o.log("[runner] Resumed"),$&&($(),$=null)}function Ue(){S&&S.abort(),ve(),$&&($(),$=null),N&&(clearInterval(N),N=null),o.update({runState:w.Idle,dwellRemainingSec:0}),o.log("[runner] Stopped")}function Me(){return new Promise(e=>{$=e})}function Ve(e){return new Promise(t=>{let a=e;o.update({dwellRemainingSec:a}),N=setInterval(()=>{o.state.runState!==w.Paused&&(a-=1,o.update({dwellRemainingSec:Math.max(0,a)}),a<=0&&(clearInterval(N),N=null,o.update({dwellRemainingSec:0}),t()),S?.signal.aborted&&(clearInterval(N),N=null,t()))},1e3)})}function Ye(){const e=d("Start Run",()=>je(),"btn-primary btn-lg"),t=d("Pause",()=>ke(),"btn-secondary"),a=d("Resume",()=>Ge(),"btn-primary"),s=d("Stop",()=>Ue(),"btn-danger"),i=n("span",{className:"run-well"},"---"),r=n("span",{className:"run-dwell"},"---"),l=n("span",{className:"run-progress"},"0 / 48"),c=n("div",{className:"progress-bar-fill"}),g=n("div",{className:"progress-bar"},c),y=n("span",{className:"run-status"},"Idle"),_=n("section",{className:"panel run-panel"},n("h2",{},"Run"),n("div",{className:"run-info"},n("div",{},n("strong",{},"Status: "),y),n("div",{},n("strong",{},"Well: "),i),n("div",{},n("strong",{},"Dwell: "),r),n("div",{},n("strong",{},"Progress: "),l)),g,n("div",{className:"run-actions"},e,t,a,s));return o.subscribe(()=>{const{runState:f,currentWell:x,dwellRemainingSec:u,wellStates:v,connection:I,calibration:U}=o.state,W=T*D;let m=0;for(const ie of v.values())ie===F.Done&&m++;i.textContent=x??"---",r.textContent=u>0?`${u}s`:"---",l.textContent=`${m} / ${W}`,c.style.width=`${m/W*100}%`,y.textContent=f.charAt(0).toUpperCase()+f.slice(1);const E=I===p.Connected,J=U!==null,se=f===w.Idle||f===w.Complete,X=f===w.Running,q=f===w.Paused;e.style.display=se?"":"none",e.disabled=!E||!J,e.title=J?"":"Calibrate the plate first",t.style.display=X?"":"none",a.style.display=q?"":"none",s.style.display=X||q?"":"none"}),_}function Je(){const e=n("div",{className:"console-log"}),t=n("input",{type:"text",placeholder:"Type G-code command...",className:"console-input"}),a=n("button",{className:"btn-primary btn-sm"},"Send");async function s(){const c=t.value.trim();if(c){t.value="";try{await h(c)}catch(g){o.log(`[console] Error: ${g}`)}}}a.addEventListener("click",s),t.addEventListener("keydown",c=>{c.key==="Enter"&&s()});const i=n("div",{className:"console-input-row"},t,a),r=n("section",{className:"panel console-panel"},n("h2",{},"Console"),e,i);let l=0;return o.subscribe(()=>{const{consoleLog:c,connection:g}=o.state,y=g!==p.Connected;if(t.disabled=y,a.disabled=y,c.length!==l){const _=c.slice(l);for(const f of _){const x=n("div",{className:`console-line ${f.startsWith(">")?"sent":f.startsWith("<")?"received":"info"}`},f);e.appendChild(x)}l=c.length,e.scrollTop=e.scrollHeight}}),r}function Xe(){const e=ue(),t=pe();if(o.update({calibration:e,runConfig:t}),!("serial"in navigator)){document.querySelector("#app").innerHTML=`
      <div class="unsupported">
        <h1>Browser Not Supported</h1>
        <p>This app requires the <strong>Web Serial API</strong>, which is only available in
           <strong>Chrome/Edge 89+</strong>.</p>
        <p>Please open this page in Chrome or Edge.</p>
      </div>
    `;return}const a=document.querySelector("#app"),s=n("pre",{className:"ascii-logo"},`  ___  ___ ___ ___   ___      _
 / __|/ __|_ _/ __| | _ ) ___| |_
| (_ |\\__ \\| |\\__ \\ | _ \\/ _ \\  _|
 \\___|___/___|___/ |___/\\___/\\__|`),i=n("header",{className:"app-header"},s,n("span",{className:"app-subtitle"},"48-Well Plate Controller")),r=n("div",{className:"col col-left"},De(),Te(),Ye(),Ae()),l=n("div",{className:"col col-right"},Ee(),Je(),Fe()),c=n("div",{className:"main-layout"},r,l);a.appendChild(i),a.appendChild(c)}Xe();
